#
# PIAACMC coronagraph
#
start
	telescope
	primaryDiameter:0.036
	primaryFRatio:85.9
	magnification:1.3376830156
end
# start here defining the input E-field
start
	efield
	outputDirectory:donutPiaaLuvoir/output/
	# filename:donutPiaaLuvoir/dmEInputRe.fits,donutPiaaLuvoir/dmEInputIm.fits
	# wavelength:650e-9
	filename:donutPiaaLuvoir/dmEInput3wRe.fits,donutPiaaLuvoir/dmEInput3wIm.fits
	wavelengthList: 624e-9 650e-9 676e-9
	#	wavelengthBandwidth: 650e-9, 0.1, 5
	beamRadiusPhysical:0.018
	pixelScale:1.757812500000000e-05
end
# ------------------------
# the coronagraph
# ------------------------
start
	coronagraph
	start
		# mirror
		# filename:donutPiaaLuvoir/run07-dmSag-final.fits
		deformableMirror
		# actuatorFilename:donutPiaaLuvoir/run07-dmSag-control.fits
		# actuatorFilename:dmOptimization/optimalActuators_crash1.fits
		# actuatorFilename:dmOptimization/poly_3w_bobyqa_opt/poly_optAct_zeroR17.fits
		# actuatorFilename:dmOptimization/poly_3w_bobyqa_opt_2/poly_optAct_R17_1p12em8.fits
		# actuatorFilename:dmOptimization/poly_3w_bobyqa_opt_3/poly_optAct_R17_iter3_2p22em9.fits
		# actuatorFilename:dmOptimization/poly_3w_bobyqa_opt_4/poly_optAct_R17_iter4_1p594em9.fits
		actuatorFilename:dmOptimization/poly_3w_bobyqa_opt_5/poly_optAct_R17_iter5_1p387em9.fits
		sigma:1.3
		position:0
		sign:-1
		optRadius: 17
		name:dm1
		# save:preExecute
		# save:postExecute
	end
	start
		fpmPupToLyot
		name:FPM
		position:0
		focalRatio: 85.9
		fRatioSign: 1
		zoomFftSign: 1
		disableForCalibration:on
		start
			fpmIntHexCMCForPupToLyot
			zoomFactor: 292.5714286000000
			start
				complexHexMaskFPM
				name:complexHexMaskFPM
				maskNRings: 20
				hexStep: 1
				fpmArraySize: 2048
				fpmScaleFactor: 0.9
				hexGap: -0.0001
				lambdaRef: 650e-9
				fpmFRatio: 85.9
				nSubPix: 64
				phaseSign: 1
				# for 8 rings
				# fpmRadius: 1.8e-04
				# for 20 or 32 rings
				fpmRadius: 1.85e-04
				# fpmRadius: 1.909557000000000e-04
				fpmMaskSize: 1024
				maskFilenameRoot:donutPiaaLuvoir/mask_data
				# sagFilename:dmOptimization/poly_3w_bobyqa_opt_5/hexOptimization/bestOptVector_bobyaDM_iter4_1p55em9.fits
				sagFilename:dmOptimization/poly_3w_bobyqa_opt_4/hexOptimization/bestOptVector_bobyaDM_iter4_1p66em9.fits
				# sagFilename:dmOptimization/poly_3w_bobyqa_opt_3/hexOptimization/bestOptVector_bobyaDM_iter3_2p0321em9.fits
				# sagFilename:dmOptimization/poly_3w_bobyqa_opt_2/hexOptimization/bestOptVector_bobyaDM_iter2_2p95em9.fits
				# sagFilename:donutPiaaLuvoir/csim_v1_bestOptVector_luvoir_donut_mono_no_fresnel.fits
				# sagFilename:donutPiaaLuvoir/3source/optTest/bestOptVector.fits
			end
		end
		# save:postExecute
	end
#	start
#		breakExecution
#	end
	start
		mask
		filename:donutPiaaLuvoir/obstrPup2048.fits
		position:0
		name:circular obstruction 3
		#save:postExecute
	end
	start
		mask
		filename:donutPiaaLuvoir/LyotMask.fits
		position:0
		name:Lyot stop
		#save:postExecute
	end
	start
		fraunhoferFocal
		position:0
		name:science CCD
		referenceLambda:650e-9
		samplesPerflD:12
		# samplesPerflD:3
		FOVflD:24
	end
end
start
	nloptOptimizer
	dataToOptimize:dm1,actuatorValues
	optMethod:bobyqa
	stopObjectiveValue: 1e-10
	maxIterations: 1000000
	xRelTolerance: 1e-12
	fRelTolerance: 1e-12
	gradientDx: 1e-12
	gradientErrorThreshold: 0
	globalBounds: -2e-7, 2e-7
	# initX:random
	start
		regionContrast
		referenceLambda:650e-9
		radii:2,8
		xlimit:2,1e16
		anglesInDegrees:-90,90
	end
	outputDirectory:dmOptimization/poly_3w_bobyqa_opt_6
end
